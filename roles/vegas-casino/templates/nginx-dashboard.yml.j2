apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-html
  namespace: {{ k8s_namespace | default("default") }}
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ACE Dashboard</title>
        <meta name="description" content="ACE Dashboard">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="https://unpkg.com/@dynatrace/groundhog@latest/dist/css/main.css">
    </head>
    <body>
        <div class="nav has-no-secondary">
            <div class="nav__brand nav__logo">
                <a href="#" onclick="showPage('home')">
                    <img src="https://assets.dynatrace.com/global/logos/dynatrace-logo.svg" alt="Dynatrace" width="100%" height="24px">
                </a>
            </div>
            <nav class="nav__bar">
                <ul class="nav__list nav__list--primary">
                    <li class="nav__item is-current" id="nav-home">
                        <a href="#" class="nav__link" onclick="showPage('home')">How-To ACE Box</a>
                    </li>
                    <li class="nav__item" id="nav-preview">
                        <a href="#" class="nav__link" onclick="showPage('preview')">Deployment Preview</a>
                    </li>
                    <li class="nav__item" id="nav-links">
                        <a href="#" class="nav__link" onclick="showPage('links')">Links</a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <main>
            <div class="layout__container">
                <div class="island">
                    <!-- How-To Page -->
                    <div id="page-home" class="page-content">
                        <h1>How-To</h1>
                        <p>Welcome to your personal ACE Box! It comes with a set of already configured tools, code, pipelines, etc. to showcase a selection of cloud automation use cases.</p>
                        <p>Before you get started, please familiarize yourself with the Dashboard you're currently looking at:</p>
                        
                        <ul>
                            <li>A <strong>How-To</strong> gives you step-by-step instructions for each use case.</li>
                            <li>As the name indicates, <strong>Deployment Preview</strong> shows you the currently deployed version of a demo application up in each stage. Don't worry, the page will fine if for now any application is not deployed yet. You will fix this as part of one the first use cases.</li>
                            <li><strong>Links</strong> lists tools and credentials that you will need while going through the use cases.</li>
                        </ul>
                        
                        <p>In addition the following tools have been set up and configured (click on each tab to get an overview of what's been configured):</p>
                        
                        <ul class="tab-nav">
                            <li class="tab-nav__item is-active">
                                <button class="tab-nav__link" data-tab="dynatrace">Dynatrace</button>
                            </li>
                            <li class="tab-nav__item">
                                <button class="tab-nav__link" data-tab="vegas">Vegas Casino</button>
                            </li>
                            <li class="tab-nav__item">
                                <button class="tab-nav__link" data-tab="mattermost">Mattermost</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content is-active" id="dynatrace">
                            <div class="service-info">
                                <h3>üîç Dynatrace Observability Platform</h3>
                                <p><strong>Dynatrace</strong> provides full-stack monitoring and AI-powered observability. You can log in using your tenant credentials. Our installation provides comprehensive monitoring for business events and application performance.</p>
                                
                                <h4>Quick Access Links</h4>
                                <ul class="link-list">
                                    <li><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}" target="_blank" rel="noreferrer">üåê Open Dynatrace Tenant</a></li>
                                    <li><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}/ui/apps/dynatrace.notebooks/" target="_blank" rel="noreferrer">üìì Notebooks</a></li>
                                    <li><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}/ui/openApp/dynatrace.services/" target="_blank" rel="noreferrer">üèóÔ∏è Services</a></li>
                                    <li><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}/ui/apps/dynatrace.automations/workflows?owner=all" target="_blank" rel="noreferrer">‚öôÔ∏è Workflows</a></li>
                                    <li><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}/ui/apps/dynatrace.biz.flow" target="_blank" rel="noreferrer">üìà Business Flow</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-content" id="vegas">
                            <div class="service-info">
                                <h3>ÔøΩ Vegas Casino Application</h3>
                                <p><strong>Vegas Casino</strong> is our comprehensive gaming platform with advanced fraud detection. It features multiple casino games including slots, blackjack, roulette, and dice games, all with real-time fraud monitoring and business observability.</p>
                                
                                <h4>Casino Games</h4>
                                <ul class="link-list">
                                    <li><a href="https://vegas.{{ ingress_domain }}/" target="_blank" rel="noreferrer">üè† Casino Lobby</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/slots.html" target="_blank" rel="noreferrer">üé∞ Slot Machines</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/blackjack.html" target="_blank" rel="noreferrer">üÉè Blackjack</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/roulette.html" target="_blank" rel="noreferrer">üé° Roulette</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/dice.html" target="_blank" rel="noreferrer">üé≤ Dice Game</a></li>
                                </ul>
                                
                                <h4>Admin & Monitoring</h4>
                                <ul class="link-list">
                                    <li><a href="https://vegas.{{ ingress_domain }}/health" target="_blank" rel="noreferrer">‚ù§Ô∏è Health Check</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/api/admin/services/status" target="_blank" rel="noreferrer">‚öôÔ∏è Admin Dashboard</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/leaderboard.html" target="_blank" rel="noreferrer">üèÜ Leaderboard</a></li>
                                    <li><a href="https://vegas.{{ ingress_domain }}/analytics.html" target="_blank" rel="noreferrer">üìä Analytics</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-content" id="mattermost">
                            <div class="service-info">
                                <h3>üí¨ Mattermost Collaboration</h3>
                                <p><strong>Mattermost</strong> is our team collaboration platform. You can use it for demo coordination, sharing insights, and communicating during the business observability demonstrations.</p>
                                
                                <div class="credential-box">
                                    <h4>üîê Login Credentials</h4>
                                    <div class="credential-item">
                                        <strong>Username:</strong> <code class="credential-value">{{ mattermost_username | default('admin') }}</code>
                                    </div>
                                    <div class="credential-item">
                                        <strong>Password:</strong> <code class="credential-value">{{ mattermost_password | default('admin123') }}</code>
                                    </div>
                                    <p class="security-note">
                                        <em>‚ö†Ô∏è Note: These are the actual deployed credentials for your Mattermost instance.</em>
                                    </p>
                                </div>
                                
                                <h4>Quick Access</h4>
                                <ul class="link-list">
                                    <li><a href="https://mattermost.{{ ingress_domain }}/" target="_blank" rel="noreferrer">üåê Open Mattermost</a></li>
                                    <li><a href="https://mattermost.{{ ingress_domain }}/login" target="_blank" rel="noreferrer">üîë Direct Login</a></li>
                                </ul>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Deployment Preview Page -->
                    <div id="page-preview" class="page-content" style="display: none;">
                        <h1>Deployment Preview</h1>
                        <p>This page shows the currently deployed version of demo applications in each environment stage.</p>
                        
                        <h2>Vegas Casino Application</h2>
                        <dl class="definition-list">
                            <dt>Production Environment</dt>
                            <dd><a href="https://vegas.{{ ingress_domain }}/" target="_blank" rel="noreferrer">Vegas Casino - Live</a></dd>
                            
                            <dt>Application Health</dt>
                            <dd><a href="https://vegas.{{ ingress_domain }}/health" target="_blank" rel="noreferrer">Health Check Endpoint</a></dd>
                            
                            <dt>Admin Interface</dt>
                            <dd><a href="https://vegas.{{ ingress_domain }}/api/admin/services/status" target="_blank" rel="noreferrer">Service Status Dashboard</a></dd>
                            
                            <dt>Casino Games</dt>
                            <dd>
                                <a href="http://vegas.{{ ingress_domain }}/slots.html" target="_blank" rel="noreferrer">Slots</a> | 
                                <a href="http://vegas.{{ ingress_domain }}/blackjack.html" target="_blank" rel="noreferrer">Blackjack</a> | 
                                <a href="http://vegas.{{ ingress_domain }}/roulette.html" target="_blank" rel="noreferrer">Roulette</a> | 
                                <a href="http://vegas.{{ ingress_domain }}/dice.html" target="_blank" rel="noreferrer">Dice</a>
                            </dd>
                        </dl>
                    </div>
                    
                    <!-- Links Page -->
                    <div id="page-links" class="page-content" style="display: none;">
                        <h1>Links</h1>
                        <p>Access deployed components and credentials for this ACE Box environment.</p>
                        
                        <h2>Core Services</h2>
                        <dl class="definition-list">
                            <dt>Dynatrace Environment</dt>
                            <dd><a href="{{ extra_vars.dt_environment_url_gen3 | default('https://your-tenant.apps.dynatrace.com') }}" target="_blank" rel="noreferrer">Access your Dynatrace tenant</a></dd>
                            
                            <dt>Vegas Casino Application</dt>
                            <dd><a href="https://vegas.{{ ingress_domain }}/" target="_blank" rel="noreferrer">Vegas Casino with fraud detection</a></dd>
                            
                            <dt>Mattermost</dt>
                            <dd>
                                <a href="https://mattermost.{{ ingress_domain }}/" target="_blank" rel="noreferrer">Team collaboration platform</a>
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: var(--color-background-subtle); border-radius: 4px;">
                                    <small><strong>Login:</strong> {{ mattermost_username | default('admin') }} / {{ mattermost_password | default('admin123') }}</small>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </main>
        
        <script src="https://unpkg.com/@dynatrace/groundhog@latest/dist/js/main.js"></script>
        <script>
            // Page navigation
            function showPage(pageId) {
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.style.display = 'none';
                });
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav__item').forEach(item => {
                    item.classList.remove('is-current');
                });
                
                // Show selected page
                document.getElementById('page-' + pageId).style.display = 'block';
                
                // Add active class to selected nav item
                document.getElementById('nav-' + pageId).classList.add('is-current');
            }
            
            // Tab functionality for How-To page
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Dashboard loaded, initializing tabs...');
                
                const tabButtons = document.querySelectorAll('.tab-nav__link');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log('Found tabs:', tabButtons.length, 'Found content:', tabContents.length);
                
                function showTab(targetTab) {
                    console.log('Showing tab:', targetTab);
                    
                    // Hide all content
                    tabContents.forEach(content => {
                        content.classList.remove('is-active');
                        content.style.display = 'none';
                    });
                    
                    // Remove active from all buttons
                    tabButtons.forEach(btn => {
                        btn.parentElement.classList.remove('is-active');
                    });
                    
                    // Show target content
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('is-active');
                        targetContent.style.display = 'block';
                        console.log('Successfully showed tab:', targetTab);
                    } else {
                        console.error('Could not find tab content:', targetTab);
                    }
                    
                    // Activate button
                    const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
                    if (activeButton) {
                        activeButton.parentElement.classList.add('is-active');
                    }
                }
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const targetTab = this.getAttribute('data-tab');
                        showTab(targetTab);
                    });
                });
                
                // Show first tab by default
                if (tabButtons.length > 0) {
                    const firstTab = tabButtons[0].getAttribute('data-tab');
                    showTab(firstTab);
                }
            });
        </script>
        <style>
            .tab-nav {
                display: flex;
                list-style: none;
                padding: 0;
                margin: 2rem 0 1rem 0;
                border-bottom: 2px solid #e0e0e0;
                background: #f8f9fa;
                border-radius: 8px 8px 0 0;
                padding: 0.5rem;
                min-height: 60px;
                align-items: center;
            }
            .tab-nav__item {
                margin-right: 0.5rem;
            }
            .tab-nav__link {
                background: transparent;
                border: none;
                padding: 1rem 1.5rem;
                cursor: pointer;
                border-radius: 6px;
                color: #666666 !important;
                font-size: 1rem;
                font-weight: 500;
                text-decoration: none;
                transition: all 0.2s ease;
                display: block;
                min-width: 140px;
                text-align: center;
            }
            .tab-nav__link:hover {
                background: #f8f9fa !important;
                color: #333333 !important;
            }
            .tab-nav__item.is-active .tab-nav__link {
                background: #0066cc !important;
                color: #ffffff !important;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .tab-nav__item.is-active .tab-nav__link:hover {
                background: #0052a3 !important;
                color: #ffffff !important;
            }
            .tab-content {
                display: none !important;
                padding: 2rem;
                background: #ffffff !important;
                border: 1px solid #e0e0e0;
                border-radius: 0 0 8px 8px;
                border-top: none;
                min-height: 300px;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .tab-content.is-active {
                display: block !important;
                opacity: 1 !important;
            }
            .tab-content[style*="display: block"] {
                display: block !important;
                opacity: 1 !important;
            }
            .page-content {
                min-height: 500px;
            }
            .service-info h3 {
                margin-top: 0;
                color: var(--color-text-primary);
                border-bottom: 2px solid var(--color-accent-default);
                padding-bottom: 0.5rem;
            }
            .service-info h4 {
                color: var(--color-text-primary);
                margin-top: 1.5rem;
                margin-bottom: 0.75rem;
            }
            .link-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .link-list li {
                margin-bottom: 0.5rem;
            }
            .link-list a {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: var(--color-background-subtle);
                border: 1px solid var(--color-border-default);
                border-radius: 4px;
                text-decoration: none;
                color: var(--color-text-primary);
                transition: all 0.2s ease;
                width: 100%;
                box-sizing: border-box;
            }
            .link-list a:hover {
                background: var(--color-accent-subtle);
                border-color: var(--color-accent-default);
                transform: translateY(-1px);
            }
            .credential-box {
                background: var(--color-background-subtle);
                border: 2px solid var(--color-accent-default);
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1rem 0;
            }
            .credential-box h4 {
                margin-top: 0;
                color: var(--color-accent-default);
            }
            .credential-item {
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: #f8f9fa;
                padding: 0.75rem;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            .credential-item strong {
                color: #333333 !important;
                min-width: 90px;
                font-weight: 600;
            }
            .credential-value {
                background: #0066cc !important;
                color: #ffffff !important;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                font-size: 1.1rem;
                font-weight: bold;
                border: 2px solid #004499;
                display: inline-block;
                user-select: all;
                -webkit-user-select: all;
                -moz-user-select: all;
                -ms-user-select: all;
                text-shadow: none;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            .credential-value:focus {
                outline: 2px solid #66aaff;
                background: #004499 !important;
            }
            .security-note {
                margin-top: 1rem;
                font-size: 0.9rem;
                color: var(--color-text-secondary);
                font-style: italic;
            }
        </style>
    </body>
    </html>
  nginx.conf: |
    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;
        
        # Logging for debugging
        access_log /var/log/nginx/access.log combined;
        error_log /var/log/nginx/error.log warn;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Main application
        location / {
            try_files $uri $uri/ /index.html;
            expires 1h;
            add_header Cache-Control "public, no-transform";
        }
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Status endpoint for debugging
        location /status {
            access_log off;
            return 200 "ACE Dashboard Running\n";
            add_header Content-Type text/plain;
        }
        
        # Handle CSS and JS files
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ace-box-dashboard
  namespace: {{ k8s_namespace | default("default") }}
  labels:
    app: ace-box-dashboard
    component: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ace-box-dashboard
  template:
    metadata:
      labels:
        app: ace-box-dashboard
        component: dashboard
    spec:
      containers:
      - name: dashboard
        image: nginx:alpine
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: dashboard-content
          mountPath: /usr/share/nginx/html
          readOnly: true
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
          readOnly: true
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        env:
        - name: INGRESS_DOMAIN
          value: "{{ ingress_domain | default('localhost') }}"
        - name: DT_ENVIRONMENT_URL
          value: "{{ extra_vars.dt_environment_url_gen3 | default('https://YOUR_TENANT.apps.dynatrace.com') }}"
        - name: VEGAS_URL
          value: "https://vegas.{{ ingress_domain | default('localhost') }}"
        - name: MATTERMOST_URL
          value: "https://mattermost.{{ ingress_domain | default('localhost') }}"
        - name: MATTERMOST_USERNAME
          value: "{{ mattermost_username | default('admin') }}"
        - name: MATTERMOST_PASSWORD
          value: "{{ mattermost_password | default('admin123') }}"
      volumes:
      - name: dashboard-content
        configMap:
          name: dashboard-html
          items:
          - key: index.html
            path: index.html
      - name: nginx-config
        configMap:
          name: dashboard-html
          items:
          - key: nginx.conf
            path: default.conf

---
apiVersion: v1
kind: Service
metadata:
  name: ace-box-dashboard-service
  namespace: {{ k8s_namespace | default("default") }}
  labels:
    app: ace-box-dashboard
spec:
  selector:
    app: ace-box-dashboard
  ports:
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ace-box-dashboard-ingress
  namespace: {{ k8s_namespace | default("default") }}
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: "public"
  rules:
  - host: dashboard.{{ ingress_domain | default('localhost') }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ace-box-dashboard-service
            port:
              number: 80